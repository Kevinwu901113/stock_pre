# 股票推荐系统融合策略说明

## 概述

本融合推荐系统将机器学习模型预测的上涨概率与原有的多因子线性打分结果进行智能融合，提供更准确和全面的股票推荐。系统支持多种融合策略，输出统一的JSON格式结果，便于后续分析和应用。

## 核心功能

### 1. 多种融合策略

#### 加权平均策略 (weighted_average)
- **原理**: 将ML预测概率和因子得分进行标准化后，按权重进行加权平均
- **适用场景**: 希望平衡考虑ML模型和因子模型的建议
- **参数配置**:
  - `ml_weight`: ML模型权重 (默认0.4)
  - `factor_weight`: 因子模型权重 (默认0.6)

#### 优先过滤策略 (filter_first)
- **原理**: 先用ML模型按概率阈值过滤股票，再用因子模型对过滤后的股票进行排序
- **适用场景**: 希望确保推荐的股票都有较高的上涨概率
- **参数配置**:
  - `ml_threshold`: ML概率阈值 (默认0.6)
  - `factor_threshold`: 因子得分阈值 (默认0.5)

#### 排序微调策略 (rank_adjustment)
- **原理**: 以因子模型排序为基础，用ML预测概率进行排序微调
- **适用场景**: 主要依赖因子模型，用ML模型进行精细调整
- **参数配置**:
  - `adjustment_factor`: 调整系数 (默认2.0)

### 2. 统一输出格式

系统输出标准JSON格式，包含以下信息：

```json
{
  "metadata": {
    "timestamp": "2024-01-15 14:30:00",
    "fusion_method": "weighted_average",
    "total_recommendations": 10,
    "top_n": 10,
    "ml_weight": 0.4,
    "factor_weight": 0.6,
    "version": "1.0.0"
  },
  "recommendations": [
    {
      "rank": 1,
      "stock_code": "600519",
      "stock_name": "贵州茅台",
      "current_price": 1680.50,
      "change_pct": 2.15,
      "final_score": 0.8542,
      "ml_probability": 0.7234,
      "factor_score": 1.2456,
      "recommendation_reason": "ML预测上涨概率72.3%; 动量表现良好(momentum_20d强势上涨); 成交量表现良好(成交量放大)",
      "fusion_details": {
        "method": "weighted_average",
        "ml_weight": 0.4,
        "factor_weight": 0.6
      },
      "score_breakdown": {
        "momentum": 0.15,
        "volume": 0.12,
        "capital_flow": 0.08,
        "sentiment": 0.06,
        "risk": -0.02
      }
    }
  ],
  "summary": {
    "avg_final_score": 0.7234,
    "avg_ml_probability": 0.6789,
    "avg_factor_score": 0.8901,
    "score_range": {
      "min": 0.5123,
      "max": 0.8542
    }
  }
}
```

## 使用方法

### 1. 基本使用

```python
from recommendation_fusion import RecommendationFusion

# 创建融合推荐系统
fusion_system = RecommendationFusion('fusion_config.yaml')

# 运行推荐（使用默认股票池）
results = fusion_system.run_fusion_recommendation()

# 打印结果
print(f"推荐数量: {len(results['recommendations'])}")
for rec in results['recommendations'][:5]:
    print(f"{rec['rank']}. {rec['stock_code']} - 得分: {rec['final_score']:.4f}")
```

### 2. 自定义股票池

```python
# 指定特定股票进行推荐
stock_codes = ['600519', '000858', '601318', '600036', '000002']
results = fusion_system.run_fusion_recommendation(stock_codes=stock_codes)
```

### 3. 切换融合策略

```python
# 使用优先过滤策略
fusion_system.fusion_method = 'filter_first'
fusion_system.ml_threshold = 0.7
fusion_system.factor_threshold = 0.6

results = fusion_system.run_fusion_recommendation()
```

### 4. 调整权重参数

```python
# 调整加权平均的权重
fusion_system.fusion_method = 'weighted_average'
fusion_system.ml_weight = 0.6  # 更重视ML模型
fusion_system.factor_weight = 0.4

results = fusion_system.run_fusion_recommendation()
```

## 配置文件说明

### fusion_config.yaml 主要配置项

```yaml
# 融合策略配置
fusion_strategy:
  method: "weighted_average"  # 融合方法
  ml_weight: 0.4             # ML权重
  factor_weight: 0.6         # 因子权重
  ml_threshold: 0.6          # ML阈值
  factor_threshold: 0.5      # 因子阈值

# 输出配置
output:
  top_recommendations: 10    # 推荐数量
  output_dir: "results"      # 输出目录

# 风险控制
risk_control:
  max_single_stock_weight: 0.1
  volatility_limit: 0.15
  liquidity_threshold: 1000000
```

## 运行示例

### 1. 运行完整示例

```bash
python run_fusion_example.py
```

这将运行以下示例：
- 比较不同融合策略
- 自定义股票列表推荐
- 参数敏感性分析

### 2. 单独运行融合推荐

```bash
python recommendation_fusion.py
```

## 输出文件说明

### 1. 推荐结果文件
- **文件名**: `fusion_recommendations_YYYYMMDD_HHMMSS.json`
- **位置**: `results/` 目录
- **内容**: 完整的推荐结果，包含元数据、推荐列表和摘要统计

### 2. 策略比较文件
- **文件名**: `strategy_comparison_YYYYMMDD_HHMMSS.json`
- **位置**: `results/` 目录
- **内容**: 不同策略的比较结果和性能指标

### 3. 日志文件
- **文件名**: `fusion_recommendation.log`
- **内容**: 详细的运行日志，包含错误信息和性能统计

## 性能优化建议

### 1. 数据缓存
- 启用缓存配置以减少重复数据获取
- 合理设置缓存过期时间

### 2. 股票池管理
- 根据实际需求选择合适的股票池大小
- 定期更新股票池，剔除不活跃股票

### 3. 参数调优
- 根据历史回测结果调整融合权重
- 定期评估和更新阈值参数

## 扩展功能

### 1. 自定义融合策略

可以继承 `RecommendationFusion` 类并实现自定义融合方法：

```python
class CustomFusion(RecommendationFusion):
    def custom_fusion_method(self, ml_predictions, factor_scores):
        # 实现自定义融合逻辑
        pass
```

### 2. 添加新的评分因子

在 `scoring_engine.py` 中添加新的因子计算方法，系统会自动纳入融合计算。

### 3. 集成外部数据源

可以扩展 `data_fetcher.py` 来集成更多数据源，丰富特征维度。

## 注意事项

1. **模型依赖**: 确保ML模型已经训练并保存在指定路径
2. **数据质量**: 定期检查数据源的可用性和数据质量
3. **参数调整**: 根据市场环境变化及时调整融合参数
4. **风险控制**: 始终关注风险控制指标，避免过度集中
5. **回测验证**: 定期进行回测验证，评估策略有效性

## 故障排除

### 常见问题

1. **ML模型加载失败**
   - 检查模型文件路径是否正确
   - 确认模型文件是否存在且完整

2. **数据获取失败**
   - 检查网络连接
   - 验证API密钥和权限

3. **推荐结果为空**
   - 检查股票池配置
   - 降低过滤阈值
   - 查看日志文件获取详细错误信息

4. **性能问题**
   - 减少股票池大小
   - 启用缓存
   - 优化数据获取频率

## 版本更新

- **v1.0.0**: 初始版本，支持三种基本融合策略
- 后续版本将添加更多融合方法和优化功能

## 联系支持

如有问题或建议，请查看日志文件或联系技术支持团队。