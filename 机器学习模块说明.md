# 机器学习预测模块说明

## 概述

本模块为股票推荐系统新增了基于LightGBM的机器学习预测功能，能够基于每日14:25前收集的特征数据，预测次日开盘是否上涨。该模块实现了完整的机器学习工作流，包括样本生成、模型训练、预测和集成。

## 核心功能

### 1. 训练样本生成
- **自动数据获取**: 从AkShare获取历史股票数据
- **特征工程**: 基于现有特征提取器构造技术指标特征
- **标签构造**: 自动生成涨跌标签（今日特征→明日开盘价是否高于今日收盘）
- **数据清洗**: 处理停牌、复权、异常值等问题
- **时间对齐**: 确保不同股票的时间序列正确对齐

### 2. 模型训练
- **算法**: 使用LightGBM梯度提升决策树
- **验证**: 时间序列交叉验证，避免数据泄露
- **评估**: 多指标评估（AUC、准确率、精确率、召回率、F1分数）
- **特征重要性**: 分析关键预测因子

### 3. 预测服务
- **实时预测**: predict_today_updown接口返回上涨概率
- **批量预测**: 支持多只股票同时预测
- **置信度评估**: 提供预测置信度等级

## 文件结构

```
├── ml_predictor.py          # 核心ML预测器类
├── train_ml_model.py        # 模型训练脚本
├── predict_stocks.py        # 股票预测脚本
├── ml_example.py           # 使用示例
├── models/                 # 模型文件目录
│   ├── lightgbm_model.pkl  # 训练好的LightGBM模型
│   ├── scaler.pkl          # 特征标准化器
│   └── feature_names.pkl   # 特征名称列表
└── 机器学习模块说明.md      # 本文档
```

## 快速开始

### 1. 安装依赖

```bash
pip install lightgbm>=3.3.0
```

### 2. 训练模型

```bash
# 使用默认参数训练（过去2年数据）
python train_ml_model.py

# 指定训练数据范围
python train_ml_model.py --start_date 2022-01-01 --end_date 2024-01-01

# 训练完成后进行样本预测测试
python train_ml_model.py --predict_sample
```

### 3. 进行预测

```bash
# 预测指定股票
python predict_stocks.py --stocks 000001 000002 600000

# 预测所有股票池中的股票
python predict_stocks.py --all_stocks

# 保存预测结果到文件
python predict_stocks.py --output predictions.json
```

### 4. 集成推荐

```bash
# 运行集成ML预测的股票推荐
python main.py
```

## 详细使用说明

### MLPredictor类

#### 初始化
```python
from ml_predictor import MLPredictor

# 使用默认配置
predictor = MLPredictor()

# 使用自定义配置
predictor = MLPredictor(config_path='custom_config.yaml')
```

#### 生成训练样本
```python
# 生成训练样本
features, labels = predictor.generate_training_samples(
    start_date='2022-01-01',
    end_date='2024-01-01',
    stock_codes=None,  # None表示使用全部股票
    min_samples_per_stock=30
)
```

#### 训练模型
```python
# 训练模型
result = predictor.train_model(
    features=features,
    labels=labels,
    test_size=0.2,
    n_splits=5
)

# 查看训练结果
print("平均AUC:", result['avg_scores']['avg_auc'])
print("特征重要性:", result['feature_importance'].head())
```

#### 预测股票
```python
# 预测指定股票
predictions = predictor.predict_today_updown(['000001', '000002'])

# 预测结果格式: {'000001': 0.65, '000002': 0.45}
for stock_code, prob in predictions.items():
    direction = '看涨' if prob > 0.5 else '看跌'
    print(f"{stock_code}: {prob:.3f} ({direction})")
```

### 配置参数

在`config.yaml`中添加ML模型配置：

```yaml
ml_model:
  model_path: "models/lightgbm_model.pkl"
  scaler_path: "models/scaler.pkl"
  feature_names_path: "models/feature_names.pkl"
  max_training_stocks: 500
  
  lgb_params:
    objective: "binary"
    metric: "binary_logloss"
    boosting_type: "gbdt"
    num_leaves: 31
    learning_rate: 0.05
    feature_fraction: 0.9
    bagging_fraction: 0.8
    bagging_freq: 5
    verbose: -1
    random_state: 42
```

## 特征工程

### 基础特征
- 价格相关：开盘价、收盘价、最高价、最低价
- 成交量相关：成交量、成交额、换手率
- 技术指标：RSI、MACD、布林带等
- 资金流向：主力资金流入流出
- 情绪指标：新闻情绪、市场情绪

### 衍生特征
- 移动平均线相对位置
- 成交量相对强度
- 价格波动率
- 高低价差比率
- 开盘收盘相对位置

## 模型性能

### 评估指标
- **AUC**: 受试者工作特征曲线下面积，衡量模型区分能力
- **准确率**: 预测正确的样本比例
- **精确率**: 预测为涨的样本中实际上涨的比例
- **召回率**: 实际上涨的样本中被正确预测的比例
- **F1分数**: 精确率和召回率的调和平均

### 预期性能
- AUC: 0.55-0.65（显著优于随机猜测的0.5）
- 准确率: 52%-58%
- 高置信度预测准确率: 60%-70%

## 风险控制

### 数据质量控制
- 自动过滤停牌股票
- 处理价格异常值
- 删除成交量为0的数据
- 前复权处理确保价格连续性

### 模型稳定性
- 时间序列交叉验证避免过拟合
- 特征标准化提高模型稳定性
- 早停机制防止过度训练

### 预测可靠性
- 置信度评估
- 模型版本管理
- 预测结果记录和回测

## 集成方式

### 与现有系统集成
1. **技术面分析**: 传统多因子评分
2. **ML预测**: 机器学习涨跌概率
3. **综合决策**: 结合两种方法的优势

### 推荐策略
- **高一致性**: 技术面看涨 + ML看涨
- **分歧提醒**: 技术面与ML预测不一致的股票
- **置信度过滤**: 只推荐高置信度的ML预测

## 使用建议

### 训练频率
- **初次训练**: 使用2年历史数据
- **定期更新**: 每月重新训练一次
- **增量更新**: 每周添加新数据

### 预测使用
- **每日预测**: 在14:25收盘前进行预测
- **结合使用**: 不要单独依赖ML预测，需结合技术面分析
- **风险控制**: 设置止损止盈，控制仓位

### 性能监控
- **预测准确率**: 定期统计预测准确率
- **收益回测**: 模拟交易验证策略效果
- **特征漂移**: 监控特征分布变化

## 注意事项

1. **数据依赖**: 模型依赖AkShare数据质量，需要稳定的网络连接
2. **计算资源**: 训练需要一定的计算时间，建议在性能较好的机器上运行
3. **市场变化**: 股票市场环境变化可能影响模型效果，需要定期重训练
4. **风险提示**: 机器学习预测仅供参考，不构成投资建议

## 故障排除

### 常见问题

1. **模型训练失败**
   - 检查网络连接
   - 确认AkShare数据可用性
   - 减少训练股票数量

2. **预测结果为空**
   - 确认模型文件存在
   - 检查股票代码格式
   - 验证数据获取是否正常

3. **性能较差**
   - 增加训练数据量
   - 调整模型参数
   - 检查特征工程质量

### 日志分析
查看日志文件了解详细错误信息：
- `ml_training.log`: 训练过程日志
- `stock_recommendation.log`: 系统运行日志

## 扩展开发

### 添加新特征
1. 在`_add_technical_features`方法中添加新的技术指标
2. 确保特征无前瞻偏差
3. 重新训练模型

### 模型优化
1. 调整LightGBM参数
2. 尝试其他算法（XGBoost、CatBoost等）
3. 集成多个模型

### 策略改进
1. 多时间框架预测
2. 行业轮动预测
3. 风险评估模型

---

**免责声明**: 本模块仅用于技术研究和学习目的，预测结果不构成投资建议。股票投资有风险，请谨慎决策。