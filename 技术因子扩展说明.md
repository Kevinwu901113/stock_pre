# 技术因子扩展说明

## 概述

本次扩展为股票推荐系统新增了多个技术因子，包括近5日涨跌幅、MACD差值、KDJ金叉、RSI、均线斜率、量比、主力资金净流入、所属行业表现、前一日涨停状态等。所有因子都支持配置化启用/禁用，并提供标准化输出。

## 新增技术因子详情

### 1. 近5日涨跌幅 (momentum_5d_new)
- **计算方式**: (当前价格 / 5日前价格 - 1) × 100
- **标准化**: 映射到0-100区间，-10%对应0，+10%对应100
- **应用场景**: 短期动量判断，识别强势/弱势股票
- **配置项**: `momentum_factors.momentum_5d_new`

### 2. MACD差值 (macd_diff)
- **计算方式**: MACD线 - 信号线
- **技术库支持**: 优先使用TA-Lib，备用自定义实现
- **标准化**: 线性变换到0-100区间
- **应用场景**: 趋势转折点识别，买卖信号判断
- **配置项**: `technical_factors.macd_diff`

### 3. KDJ金叉信号 (kdj_golden_cross)
- **计算方式**: K线从下方穿越D线时产生金叉信号
- **技术库支持**: 优先使用pandas-ta，备用自定义实现
- **输出值**: 
  - 100: 强烈金叉信号（K>D且K<80）
  - 60: 一般金叉信号（K>D）
  - 20: 无金叉或死叉
- **应用场景**: 短期买入时机判断
- **配置项**: `technical_factors.kdj_golden_cross`

### 4. 均线斜率 (ma_slope_5d, ma_slope_10d)
- **计算方式**: (当前MA - 前一期MA) / 前一期MA × 100
- **标准化**: 映射到0-100区间，-5%对应0，+5%对应100
- **应用场景**: 趋势强度判断，均线方向确认
- **配置项**: `technical_factors.ma_slope_5d`, `technical_factors.ma_slope_10d`

### 5. 量比 (volume_ratio_new)
- **计算方式**: 当前成交量 / 前5日平均成交量
- **标准化**: 对数变换后映射到0-100区间
- **应用场景**: 成交量异常识别，资金关注度判断
- **配置项**: `volume_factors.volume_ratio_new`

### 6. 前一日涨停状态 (limit_up_yesterday)
- **计算方式**: 检查前一日涨幅是否接近涨停（≥9.8%）
- **输出值**:
  - 100: 前日涨停（≥9.8%）
  - 60: 前日大涨（≥7%）
  - 30: 前日上涨（≥3%）
  - 0: 前日未上涨
- **应用场景**: 连板潜力判断，热点延续性分析
- **配置项**: `market_state_factors.limit_up_yesterday`

### 7. 所属行业表现 (sector_performance)
- **计算方式**: 根据股票代码判断所属行业，获取行业整体表现
- **标准化**: 映射到0-100区间，-10%对应0，+10%对应100
- **应用场景**: 行业轮动判断，板块效应分析
- **配置项**: `market_state_factors.sector_performance`

### 8. 主力资金净流入 (main_capital_inflow)
- **计算方式**: 基于主力资金净流入百分比标准化
- **标准化**: 50为中性，>50为净流入，<50为净流出
- **应用场景**: 资金面分析，主力动向判断
- **配置项**: `capital_flow_factors.main_capital_inflow`

## 技术库支持

### TA-Lib
- **用途**: MACD、RSI等经典技术指标计算
- **安装**: `pip install TA-Lib`
- **备用方案**: 自定义实现，确保在未安装时正常运行

### pandas-ta
- **用途**: KDJ、随机指标等现代技术分析
- **安装**: `pip install pandas-ta`
- **备用方案**: 简化的自定义实现

## 配置文件说明

### 1. factor_enable_config.yaml
控制各个因子的启用状态：
```yaml
momentum_factors:
  momentum_5d_new: true      # 启用近5日涨跌幅
  
technical_factors:
  macd_diff: true            # 启用MACD差值
  kdj_golden_cross: true     # 启用KDJ金叉
```

### 2. factor_config.yaml
控制各个因子的权重：
```yaml
factor_weights:
  momentum_5d_new: 0.08      # 近5日涨跌幅权重
  macd_diff: 0.03            # MACD差值权重
  kdj_golden_cross: 0.04     # KDJ金叉权重
```

### 3. 全局设置
```yaml
global_settings:
  enable_normalization: true          # 启用标准化
  missing_data_strategy: "zero"       # 缺失数据处理策略
  outlier_handling:
    enable: true
    method: "clip"                    # 异常值处理方法
```

## 使用示例

### 基本用法
```python
from feature_extractor import FeatureExtractor

# 初始化特征提取器
extractor = FeatureExtractor(
    config_path="config.yaml",
    factor_strategy="default",
    time_period="medium_term",
    factor_enable_config_path="factor_enable_config.yaml"
)

# 提取特征
features = extractor.extract_all_features(stock_data, stock_code="000001")

# 查看新增因子
print(f"近5日涨跌幅: {features.get('momentum_5d_new', 'N/A')}")
print(f"KDJ金叉信号: {features.get('kdj_golden_cross', 'N/A')}")
print(f"前日涨停状态: {features.get('limit_up_yesterday', 'N/A')}")
```

### 批量处理
```python
# 批量提取多只股票的特征
all_features = extractor.batch_extract_features(all_stock_data)

# 筛选具有金叉信号的股票
golden_cross_stocks = {
    code: features for code, features in all_features.items()
    if features.get('kdj_golden_cross', 0) > 80
}
```

## 数据要求与容错处理

### 最少数据要求
- **基础因子**: 至少5个交易日数据
- **MACD相关**: 至少35个交易日数据
- **KDJ相关**: 至少14个交易日数据
- **均线斜率**: 至少对应周期+2个交易日数据

### 容错机制
1. **数据不足**: 自动返回默认值（通常为中性值50）
2. **计算异常**: 捕获异常并记录日志，返回安全默认值
3. **缺失字段**: 使用配置的缺失数据策略处理
4. **异常值**: 可配置截断或移除策略

## 性能优化

### 计算效率
- 优先使用高效的技术分析库（TA-Lib、pandas-ta）
- 向量化计算，避免循环
- 合理的数据缓存机制

### 内存管理
- 及时释放大型DataFrame
- 分批处理大量股票数据
- 可配置的数据保留策略

## 扩展指南

### 添加新因子
1. 在`FeatureExtractor`类中添加计算方法
2. 在`factor_enable_config.yaml`中添加启用配置
3. 在`factor_config.yaml`中添加权重配置
4. 在`_normalize_single_factor`方法中添加标准化逻辑
5. 更新文档和示例

### 自定义标准化
```python
def _normalize_single_factor(self, factor_name: str, factor_value: float) -> float:
    if factor_name == 'my_custom_factor':
        # 自定义标准化逻辑
        return max(0, min(100, custom_transform(factor_value)))
    # ... 其他因子处理
```

## 测试与验证

### 运行演示脚本
```bash
python factor_demo.py
```

### 单元测试
```python
# 测试特定因子
extractor = FeatureExtractor()
test_data = generate_sample_data("000001", days=60)
features = extractor.extract_all_features(test_data, "000001")

# 验证因子范围
assert 0 <= features['momentum_5d_new'] <= 100
assert 0 <= features['kdj_golden_cross'] <= 100
```

## 注意事项

1. **数据质量**: 确保输入的历史数据完整且格式正确
2. **时间对齐**: 所有时间序列数据应按日期正确排序
3. **参数调优**: 根据实际市场情况调整技术指标参数
4. **回测验证**: 新增因子应通过历史回测验证有效性
5. **实时更新**: 确保实时数据的及时性和准确性

## 更新日志

### v2.0 (当前版本)
- 新增9个技术因子
- 支持TA-Lib和pandas-ta技术分析库
- 完善的配置化管理
- 标准化输出和容错处理
- 批量处理优化

### 未来计划
- 更多技术指标支持（布林带宽度、威廉指标等）
- 机器学习因子（PCA降维、因子合成等）
- 实时因子更新机制
- 因子有效性自动评估